"use strict";
var __assign = (this && this.__assign) || function () {
    __assign = Object.assign || function(t) {
        for (var s, i = 1, n = arguments.length; i < n; i++) {
            s = arguments[i];
            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))
                t[p] = s[p];
        }
        return t;
    };
    return __assign.apply(this, arguments);
};
Object.defineProperty(exports, "__esModule", { value: true });
var styles_1 = require("@fluentui/styles");
var React = require("react");
var _ = require("lodash");
var enzyme_1 = require("enzyme");
var utils_1 = require("src/utils");
var utils_2 = require("test/utils");
/**
 * Returns the result of a shorthand factory.
 */
var getShorthand = function (_a) {
    var _b = _a.Component, Component = _b === void 0 ? 'div' : _b, defaultProps = _a.defaultProps, _c = _a.mappedProp, mappedProp = _c === void 0 ? '' : _c, _d = _a.mappedArrayProp, mappedArrayProp = _d === void 0 ? '' : _d, overrideProps = _a.overrideProps, generateKey = _a.generateKey, value = _a.value, render = _a.render;
    return utils_1.createShorthandInternal({
        Component: Component,
        mappedProp: mappedProp,
        mappedArrayProp: mappedArrayProp,
        value: value,
        options: {
            defaultProps: defaultProps,
            overrideProps: overrideProps,
            generateKey: generateKey,
            render: render,
        },
    });
};
var isValuePrimitive = function (value) {
    return typeof value === 'string' || typeof value === 'number' || React.isValidElement(value);
};
var testCreateShorthand = function (shorthandArgs, expectedResult) {
    return expect(enzyme_1.shallow(getShorthand(shorthandArgs)).props()).toEqual(expectedResult);
};
// ----------------------------------------
// Common tests
// ----------------------------------------
var itReturnsNull = function (value) {
    test('returns null', function () {
        utils_2.consoleUtil.disableOnce();
        expect(getShorthand({ value: value })).toBe(null);
    });
};
var itReturnsNullGivenDefaultProps = function (value) {
    test('returns null given defaultProps object', function () {
        utils_2.consoleUtil.disableOnce();
        expect(getShorthand({ value: value, defaultProps: function () { return ({ 'data-foo': 'foo' }); } })).toBe(null);
    });
};
var itReturnsAValidElement = function (value) {
    test('returns a valid element', function () {
        expect(React.isValidElement(getShorthand({ value: value }))).toBe(true);
    });
};
var itAppliesDefaultProps = function (value) {
    test('applies defaultProps', function () {
        var defaultPropsValue = { some: 'defaults' };
        var expectedResult = isValuePrimitive(value) ? __assign(__assign({}, defaultPropsValue), { children: value }) : defaultPropsValue;
        testCreateShorthand({ value: value, defaultProps: function () { return defaultPropsValue; } }, expectedResult);
    });
};
var itDoesNotIncludePropsFromMappedProp = function (value) {
    test('does not include props from mappedProp', function () {
        var mappedProp = 'data-foo';
        var wrapper = enzyme_1.shallow(getShorthand({ value: value, mappedProp: mappedProp }));
        expect(wrapper.prop(mappedProp)).not.toBeDefined();
    });
};
var itMergesClassNames = function (classNameSource, extraClassName, shorthandConfig) {
    test("merges defaultProps className and " + classNameSource + " className", function () {
        var defaultProps = function () { return ({ className: 'default' }); };
        var overrideProps = { className: 'override' };
        var expectedClassNames = 'default override';
        if (!isValuePrimitive(shorthandConfig.value)) {
            expectedClassNames += " " + extraClassName;
        }
        expect(enzyme_1.shallow(getShorthand(__assign({ defaultProps: defaultProps, overrideProps: overrideProps }, shorthandConfig))).hasClass(expectedClassNames)).toBe(true);
    });
};
var itAppliesProps = function (propsSource, expectedProps, shorthandConfig) {
    test("applies props from the " + propsSource + " props", function () {
        testCreateShorthand(shorthandConfig, expectedProps);
    });
};
var itOverridesDefaultProps = function (propsSource, defaultProps, expectedProps, shorthandConfig) {
    test("overrides defaultProps with " + propsSource + " props", function () {
        testCreateShorthand(__assign({ defaultProps: defaultProps }, shorthandConfig), expectedProps);
    });
};
var mappedProps = {
    iframe: 'src',
    img: 'src',
    input: 'type',
};
var itOverridesDefaultPropsWithFalseyProps = function (propsSource, shorthandConfig) {
    test("overrides defaultProps with falsey " + propsSource + " props", function () {
        var defaultProps = function () { return ({ undef: '-', nil: '-', zero: '-', empty: '-' }); };
        var expectedProps = { undef: undefined, nil: null, zero: 0, empty: '' };
        testCreateShorthand(__assign({ defaultProps: defaultProps }, shorthandConfig), expectedProps);
    });
};
// ----------------------------------------
// Assertions
// ----------------------------------------
describe('factories', function () {
    describe('createShorthandFactory', function () {
        test('is a function', function () {
            expect(typeof utils_1.createShorthandFactory).toBe('function');
        });
        test('does not throw if passed a function Component', function () {
            var goodUsage = function () {
                // @ts-ignore
                return utils_1.createShorthandFactory({ Component: function () { return React.createElement("div", null); }, mappedProp: 'children' });
            };
            expect(goodUsage).not.toThrowError();
        });
        test('does not throw if passed a forwardRef Component', function () {
            var goodUsage = function () {
                // @ts-ignore
                return utils_1.createShorthandFactory({ Component: React.forwardRef(function () { return null; }), mappedProp: 'children' });
            };
            expect(goodUsage).not.toThrowError();
        });
        test('does not throw if passed a string Component', function () {
            var goodUsage = function () { return utils_1.createShorthandFactory({ Component: 'div', mappedProp: 'className' }); };
            expect(goodUsage).not.toThrowError();
        });
        test('does not throw if do not passed `mappedProp`', function () {
            var goodUsage = function () { return utils_1.createShorthandFactory({ Component: function () { return React.createElement("div", null); } }); };
            expect(goodUsage).not.toThrowError();
        });
        test('throw if passed Component that is not a string nor function', function () {
            utils_2.consoleUtil.disableOnce();
            var badComponents = [undefined, null, true, false, [], {}, 123];
            _.each(badComponents, function (badComponent) {
                var badUsage = function () { return utils_1.createShorthandFactory({ Component: badComponent, mappedProp: '' }); };
                expect(badUsage).toThrowError();
            });
        });
    });
    describe('createShorthand', function () {
        test('is a function', function () {
            expect(typeof utils_1.createShorthandInternal).toBe('function');
        });
        test('does not throw if passed a function Component', function () {
            var goodUsage = function () { return utils_1.createShorthandInternal({ Component: function () { return React.createElement("div", null); }, mappedProp: '' }); };
            expect(goodUsage).not.toThrowError();
        });
        test('does not throw if passed a string Component', function () {
            var goodUsage = function () { return utils_1.createShorthandInternal({ Component: 'div', mappedProp: '' }); };
            expect(goodUsage).not.toThrowError();
        });
        test('throw if passed Component that is not a string nor function', function () {
            utils_2.consoleUtil.disableOnce();
            var badComponents = [undefined, null, true, false, [], {}, 123];
            _.each(badComponents, function (badComponent) {
                var badUsage = function () { return utils_1.createShorthandInternal({ Component: badComponent, mappedProp: '' }); };
                expect(badUsage).toThrowError();
            });
        });
        describe('styles', function () {
            test('deep merges styles prop onto defaultProps styles', function () {
                expect.assertions(1);
                var defaultProps = function () { return ({
                    styles: {
                        color: 'override me',
                        ':hover': { color: 'blue' },
                    },
                }); };
                var props = {
                    styles: { color: 'black' },
                };
                // render callback is deprecated an throws deprecation warnings
                utils_2.consoleUtil.disableOnce();
                getShorthand({
                    value: __assign(__assign({}, props), { children: function (Component, props) {
                            expect(styles_1.callable(props.styles)()).toMatchObject({
                                color: 'black',
                                ':hover': { color: 'blue' },
                            });
                        } }),
                    Component: 'p',
                    defaultProps: defaultProps,
                });
            });
            test('deep merges overrideProps styles onto styles prop', function () {
                expect.assertions(1);
                var overrideProps = {
                    styles: {
                        color: 'black',
                        ':hover': {
                            color: 'blue',
                        },
                    },
                };
                var props = {
                    styles: {
                        position: 'keep',
                        color: 'override',
                        ':hover': {
                            position: 'keep',
                            color: 'override',
                        },
                    },
                };
                // render callback is deprecated an throws deprecation warnings
                utils_2.consoleUtil.disableOnce();
                getShorthand({
                    value: __assign(__assign({}, props), { children: function (Component, props) {
                            expect(styles_1.callable(props.styles)()).toMatchObject({
                                position: 'keep',
                                color: 'black',
                                ':hover': {
                                    position: 'keep',
                                    color: 'blue',
                                },
                            });
                        } }),
                    Component: 'p',
                    overrideProps: overrideProps,
                });
            });
            test('deep merges styles prop as function onto defaultProps styles', function () {
                expect.assertions(1);
                var defaultProps = function () { return ({
                    styles: function () { return ({
                        color: 'override me',
                        ':hover': { color: 'blue' },
                    }); },
                }); };
                var props = {
                    styles: { color: 'black' },
                };
                // render callback is deprecated an throws deprecation warnings
                utils_2.consoleUtil.disableOnce();
                getShorthand({
                    value: __assign(__assign({}, props), { children: function (Component, props) {
                            expect(styles_1.callable(props.styles)()).toMatchObject({
                                color: 'black',
                                ':hover': { color: 'blue' },
                            });
                        } }),
                    Component: 'p',
                    defaultProps: defaultProps,
                });
            });
            test('deep merges overrideProps styles as function onto styles prop', function () {
                expect.assertions(1);
                var overrideProps = {
                    styles: function () { return ({
                        color: 'black',
                        ':hover': {
                            color: 'blue',
                        },
                    }); },
                };
                var props = {
                    styles: {
                        position: 'keep',
                        color: 'override',
                        ':hover': {
                            position: 'keep',
                            color: 'override',
                        },
                    },
                };
                // render callback is deprecated an throws deprecation warnings
                utils_2.consoleUtil.disableOnce();
                getShorthand({
                    value: __assign(__assign({}, props), { children: function (Component, props) {
                            expect(styles_1.callable(props.styles)()).toMatchObject({
                                position: 'keep',
                                color: 'black',
                                ':hover': {
                                    position: 'keep',
                                    color: 'blue',
                                },
                            });
                        } }),
                    Component: 'p',
                    overrideProps: overrideProps,
                });
            });
        });
        describe('defaultProps', function () {
            test('can be an object', function () {
                var defaultPropsValue = { 'data-some': 'defaults' };
                testCreateShorthand({ defaultProps: function () { return defaultPropsValue; }, value: 'foo' }, __assign(__assign({}, defaultPropsValue), { children: 'foo' }));
            });
            test('returns empty object if the result of the function is undefined', function () {
                testCreateShorthand({ defaultProps: function () { return undefined; }, value: 'foo' }, { children: 'foo' });
            });
        });
        describe('key', function () {
            beforeEach(function () {
                // silence React's warning about accessing the `key` prop
                utils_2.consoleUtil.disableOnce();
            });
            test('is not consumed', function () {
                expect(getShorthand({ value: { key: 123 } }).props).toHaveProperty('key');
            });
            describe('on an element', function () {
                test('works with a string', function () {
                    expect(getShorthand({ value: React.createElement("div", { key: "foo" }) })).toHaveProperty('key', 'foo');
                });
                test('works with a number', function () {
                    expect(getShorthand({ value: React.createElement("div", { key: 123 }) })).toHaveProperty('key', '123');
                });
                test('works with falsy values', function () {
                    var elementWithoutKey = getShorthand({ value: React.createElement("p", null) });
                    expect(elementWithoutKey).toHaveProperty('key', null);
                    expect(elementWithoutKey.props.children.key).toBe(null);
                    var elementWithNullKey = getShorthand({ value: React.createElement("p", { key: null }) });
                    expect(elementWithNullKey).toHaveProperty('key', 'null');
                    expect(elementWithoutKey.props.children.key).toBe(null);
                    expect(getShorthand({ value: React.createElement("div", { key: 0 }) })).toHaveProperty('key', '0');
                    expect(getShorthand({ value: React.createElement("div", { key: "" }) })).toHaveProperty('key', '');
                });
            });
            describe('on an object', function () {
                test('works with a string', function () {
                    expect(getShorthand({ value: { key: 'foo' } })).toHaveProperty('key', 'foo');
                });
                test('works with a number', function () {
                    expect(getShorthand({ value: { key: 123 } })).toHaveProperty('key', '123');
                });
                test('works with falsy values', function () {
                    expect(getShorthand({ value: { key: null } })).toHaveProperty('key', 'null');
                    expect(getShorthand({ value: { key: 0 } })).toHaveProperty('key', '0');
                    expect(getShorthand({ value: { key: '' } })).toHaveProperty('key', '');
                });
            });
            describe('when value is a string', function () {
                test('is generated from the value', function () {
                    expect(getShorthand({ value: 'foo' })).toHaveProperty('key', 'foo');
                });
                test('is not generated if generateKey is false', function () {
                    expect(getShorthand({ value: 'foo', generateKey: false })).toHaveProperty('key', null);
                });
            });
            describe('when value is a number', function () {
                test('is generated from the value', function () {
                    expect(getShorthand({ value: 123 })).toHaveProperty('key', '123');
                });
                test('is not generated if generateKey is false', function () {
                    expect(getShorthand({ value: 123, generateKey: false })).toHaveProperty('key', null);
                });
            });
        });
        describe('overrideProps', function () {
            var testValue = 'foo';
            test('can be an object', function () {
                var overrideProps = { 'data-some': 'overrides' };
                testCreateShorthand({ overrideProps: overrideProps, value: testValue }, __assign(__assign({}, overrideProps), { children: testValue }));
            });
            test('can be a function that returns defaultProps', function () {
                var overrideProps = function () { return ({ 'data-some': 'overrides', children: testValue }); };
                testCreateShorthand({ overrideProps: overrideProps, value: testValue }, overrideProps());
            });
            test("is called with the user's element's and default props", function () {
                var defaultPropsValue = { 'data-some': 'defaults' };
                var overrideProps = jest.fn(function () { return ({}); });
                enzyme_1.shallow(getShorthand({
                    defaultProps: function () { return defaultPropsValue; },
                    overrideProps: overrideProps,
                    value: React.createElement("div", null),
                }));
                expect(overrideProps).toHaveBeenCalledWith(defaultPropsValue);
            });
            test("is called with the user's props object", function () {
                var defaultPropsValue = { 'data-some': 'defaults' };
                var overrideProps = jest.fn(function () { return ({}); });
                var userProps = { 'data-user': 'props' };
                enzyme_1.shallow(getShorthand({
                    defaultProps: function () { return defaultPropsValue; },
                    overrideProps: overrideProps,
                    value: userProps,
                }));
                expect(overrideProps).toHaveBeenCalledWith(__assign(__assign({}, defaultPropsValue), userProps));
            });
        });
        describe('from undefined', function () {
            itReturnsNull(undefined);
            itReturnsNullGivenDefaultProps(undefined);
        });
        describe('from null', function () {
            itReturnsNull(null);
            itReturnsNullGivenDefaultProps(null);
        });
        describe('from true', function () {
            itReturnsNull(true);
            itReturnsNullGivenDefaultProps(true);
        });
        describe('from false', function () {
            itReturnsNull(false);
            itReturnsNullGivenDefaultProps(false);
        });
        describe('from an element', function () {
            itReturnsAValidElement(React.createElement("div", null));
            itAppliesDefaultProps(React.createElement("div", null));
            itMergesClassNames('mappedProp', 'mapped', {
                value: React.createElement("div", null),
                mappedProp: 'className',
            });
            itAppliesProps('mappedProp', { 'data-prop': React.createElement("div", null) }, {
                value: React.createElement("div", null),
                mappedProp: 'data-prop',
            });
            itOverridesDefaultProps('mappedProp', function () { return ({ some: 'defaults', overridden: null }); }, { some: 'defaults', overridden: React.createElement("div", null) }, {
                value: React.createElement("div", null),
                mappedProp: 'overridden',
            });
        });
        describe('from a string', function () {
            itReturnsAValidElement('foo');
            itAppliesDefaultProps('foo');
            itMergesClassNames('mappedProp', 'mapped', {
                value: 'foo',
                mappedProp: 'className',
            });
            itAppliesProps('mappedProp', { 'data-prop': 'foo' }, {
                value: 'foo',
                mappedProp: 'data-prop',
            });
            itOverridesDefaultProps('mappedProp', function () { return ({ some: 'defaults', overridden: 'false' }); }, { some: 'defaults', overridden: 'true' }, {
                value: 'true',
                mappedProp: 'overridden',
            });
            var mappedProp = 'test-mapped-prop';
            var value = 'test-value';
            describe("when sending HTML tag ", function () {
                _.forEach(mappedProps, function (val, as) {
                    var testMsg = "spreads { " + [mappedProps[as]] + ": '" + value + "' }";
                    describe("'" + as + "' as 'as' prop to defaultProps", function () {
                        test("overrides " + mappedProp + " and " + testMsg, function () {
                            var _a;
                            testCreateShorthand({ mappedProp: mappedProp, value: value, defaultProps: function () { return ({ as: as }); } }, (_a = { as: as }, _a[mappedProps[as]] = value, _a));
                        });
                    });
                    describe("'" + as + "' as 'as' prop to overrideProps", function () {
                        test("overrides " + mappedProp + " and " + testMsg, function () {
                            var _a;
                            testCreateShorthand({ mappedProp: mappedProp, value: value, overrideProps: { as: as } }, (_a = { as: as }, _a[mappedProps[as]] = value, _a));
                        });
                    });
                    describe("'" + as + "' as 'as' prop to overrideProps", function () {
                        test("overrides defaultProps, " + mappedProp + " and " + testMsg, function () {
                            var _a;
                            testCreateShorthand({
                                mappedProp: mappedProp,
                                value: value,
                                defaultProps: function () { return ({ as: 'overriden' }); },
                                overrideProps: { as: as },
                            }, (_a = { as: as }, _a[mappedProps[as]] = value, _a));
                        });
                    });
                });
            });
            describe("when sending " + mappedProp + " as mappedProp", function () {
                var testMsg = "spreads { " + [mappedProp] + ": '" + value + "' }";
                describe("and an unsupported tag as 'as' prop to defaultProps", function () {
                    test(testMsg, function () {
                        var _a;
                        testCreateShorthand({
                            mappedProp: mappedProp,
                            value: value,
                            defaultProps: function () { return ({ as: 'unsupported' }); },
                        }, (_a = { as: 'unsupported' }, _a[mappedProp] = value, _a));
                    });
                });
                describe("and an unsupported tag as 'as' prop to overrideProps", function () {
                    test(testMsg, function () {
                        var _a;
                        testCreateShorthand({ mappedProp: mappedProp, value: value, overrideProps: { as: 'unsupported' } }, (_a = { as: 'unsupported' }, _a[mappedProp] = value, _a));
                    });
                });
                describe("an unsupported tag as 'as' prop to overrideProps and a supported tag to defaultProps", function () {
                    test(testMsg, function () {
                        var _a;
                        testCreateShorthand({
                            mappedProp: mappedProp,
                            value: value,
                            defaultProps: function () { return ({ as: 'div' }); },
                            overrideProps: { as: 'unsupported' },
                        }, (_a = { as: 'unsupported' }, _a[mappedProp] = value, _a));
                    });
                });
            });
            describe("when sending no mappedProp", function () {
                var testMsg = "spreads { children: '" + value + "' } by default";
                describe("and an unsupported tag as 'as' prop to defaultProps", function () {
                    test(testMsg, function () {
                        testCreateShorthand({ value: value, defaultProps: function () { return ({ as: 'unsupported' }); } }, { as: 'unsupported', children: value });
                    });
                });
                describe("and an unsupported tag as 'as' prop to overrideProps", function () {
                    test(testMsg, function () {
                        testCreateShorthand({ value: value, overrideProps: { as: 'unsupported' } }, { as: 'unsupported', children: value });
                    });
                });
                describe("an unsupported tag as 'as' prop to overrideProps and a supported tag to defaultProps", function () {
                    test(testMsg, function () {
                        testCreateShorthand({
                            value: value,
                            defaultProps: function () { return ({ as: 'div' }); },
                            overrideProps: { as: 'unsupported' },
                        }, { as: 'unsupported', children: value });
                    });
                });
            });
        });
        describe('from a props object', function () {
            itReturnsAValidElement({});
            itAppliesDefaultProps({});
            itDoesNotIncludePropsFromMappedProp({});
            itMergesClassNames('props object', 'user', {
                value: { className: 'user' },
            });
            itOverridesDefaultProps('props object', function () { return ({ some: 'defaults', overridden: false }); }, { some: 'defaults', overridden: true }, { value: { overridden: true } });
            itOverridesDefaultPropsWithFalseyProps('props object', {
                value: { undef: undefined, nil: null, zero: 0, empty: '' },
            });
        });
        describe('from an array', function () {
            var mappedArrayProp = 'test-mapped-prop-ar-array';
            var value = ['test-value'];
            describe("when sending mappedArrayProp", function () {
                var testMsg = "spreads { " + mappedArrayProp + ": '" + value + "' }";
                describe("and an unsupported tag as 'as' prop to defaultProps", function () {
                    test(testMsg, function () {
                        var _a;
                        testCreateShorthand({
                            mappedArrayProp: mappedArrayProp,
                            value: value,
                            defaultProps: function () { return ({ as: 'unsupported' }); },
                        }, (_a = { as: 'unsupported' }, _a[mappedArrayProp] = value, _a));
                    });
                });
            });
        });
        describe('style', function () {
            test('merges style prop', function () {
                var defaultProps = function () { return ({ style: { left: 5 } }); };
                var userProps = { style: { bottom: 5 } };
                var overrideProps = { style: { right: 5 } };
                expect(enzyme_1.shallow(getShorthand({ defaultProps: defaultProps, overrideProps: overrideProps, value: userProps })).prop('style')).toEqual({
                    left: 5,
                    bottom: 5,
                    right: 5,
                });
            });
            test('merges style prop and handles override by userProps', function () {
                var defaultProps = function () { return ({ style: { left: 10, bottom: 5 } }); };
                var userProps = { style: { bottom: 10 } };
                expect(enzyme_1.shallow(getShorthand({ defaultProps: defaultProps, value: userProps })).prop('style')).toEqual({
                    left: 10,
                    bottom: 10,
                });
            });
            test('merges style prop and handles override by overrideProps', function () {
                var userProps = { style: { bottom: 10, right: 5 } };
                var overrideProps = { style: { right: 10 } };
                expect(enzyme_1.shallow(getShorthand({ overrideProps: overrideProps, value: userProps })).prop('style')).toEqual({
                    bottom: 10,
                    right: 10,
                });
            });
            test('merges style prop from defaultProps and overrideProps', function () {
                var defaultProps = function () { return ({ style: { left: 10, bottom: 5 } }); };
                var overrideProps = { style: { bottom: 10 } };
                expect(enzyme_1.shallow(getShorthand({ defaultProps: defaultProps, overrideProps: overrideProps, value: 'foo' })).prop('style')).toEqual({
                    left: 10,
                    bottom: 10,
                });
            });
        });
    });
});
