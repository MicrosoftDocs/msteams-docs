{"version":3,"sources":["context-selector/createContext.ts"],"names":["createProvider","Original","Provider","props","valueRef","React","useRef","value","versionRef","contextValue","current","version","listeners","forEach","listener","createElement","children","process","env","NODE_ENV","displayName","createContext","defaultValue","context","Consumer"],"mappings":";;;;;AAAA;;AAGA;;;;;;AAEA,IAAMA,cAAc,GAAG,SAAjBA,cAAiB,CAAQC,QAAR,EAA0D;AAC/E,MAAMC,QAA8C,GAAG,SAAjDA,QAAiD,CAAAC,KAAK,EAAI;AAC9D;AACA,QAAMC,QAAQ,GAAGC,KAAK,CAACC,MAAN,CAAaH,KAAK,CAACI,KAAnB,CAAjB,CAF8D,CAG9D;;AACA,QAAMC,UAAU,GAAGH,KAAK,CAACC,MAAN,CAAa,CAAb,CAAnB,CAJ8D,CAM9D;;AACA,QAAMG,YAAY,GAAGJ,KAAK,CAACC,MAAN,EAArB;;AAEA,QAAI,CAACG,YAAY,CAACC,OAAlB,EAA2B;AACzBD,MAAAA,YAAY,CAACC,OAAb,GAAuB;AACrBH,QAAAA,KAAK,EAAEH,QADc;AAErBO,QAAAA,OAAO,EAAEH,UAFY;AAGrBI,QAAAA,SAAS,EAAE;AAHU,OAAvB;AAKD;;AAED,0CAA0B,YAAM;AAC9BR,MAAAA,QAAQ,CAACM,OAAT,GAAmBP,KAAK,CAACI,KAAzB;AACAC,MAAAA,UAAU,CAACE,OAAX,IAAsB,CAAtB;AAEA,wCAAsB,YAAM;AACzBD,QAAAA,YAAY,CAACC,OAAd,CAA8CE,SAA9C,CAAwDC,OAAxD,CAAgE,UAAAC,QAAQ,EAAI;AAC1EA,UAAAA,QAAQ,CAAC,CAACN,UAAU,CAACE,OAAZ,EAAqBP,KAAK,CAACI,KAA3B,CAAD,CAAR;AACD,SAFD;AAGD,OAJD;AAKD,KATD,EASG,CAACJ,KAAK,CAACI,KAAP,CATH;AAWA,wBAAOF,KAAK,CAACU,aAAN,CAAoBd,QAApB,EAA8B;AAAEM,MAAAA,KAAK,EAAEE,YAAY,CAACC;AAAtB,KAA9B,EAA+DP,KAAK,CAACa,QAArE,CAAP;AACD,GA7BD;AA+BA;;;AACA,MAAIC,OAAO,CAACC,GAAR,CAAYC,QAAZ,KAAyB,YAA7B,EAA2C;AACzCjB,IAAAA,QAAQ,CAACkB,WAAT,GAAuB,0BAAvB;AACD;;AAED,SAAOlB,QAAP;AACD,CAtCD;;AAwCO,IAAMmB,aAAa,GAAG,SAAhBA,aAAgB,CAAQC,YAAR,EAAgD;AAC3E,MAAMC,OAAO,gBAAGlB,KAAK,CAACgB,aAAN,CAAyC;AACvDd,IAAAA,KAAK,EAAE;AAAEG,MAAAA,OAAO,EAAEY;AAAX,KADgD;AAEvDX,IAAAA,OAAO,EAAE;AAAED,MAAAA,OAAO,EAAE,CAAC;AAAZ,KAF8C;AAGvDE,IAAAA,SAAS,EAAE;AAH4C,GAAzC,CAAhB;AAMAW,EAAAA,OAAO,CAACrB,QAAR,GAAmBF,cAAc,CAAQuB,OAAO,CAACrB,QAAhB,CAAjC,CAP2E,CAS3E;;AACA,SAASqB,OAAF,CAAyCC,QAAhD;AAEA,SAAQD,OAAR;AACD,CAbM","sourcesContent":["import * as React from 'react';\n\nimport { Context, ContextValue } from './types';\nimport { runWithNormalPriority, useIsomorphicLayoutEffect } from './utils';\n\nconst createProvider = <Value>(Original: React.Provider<ContextValue<Value>>) => {\n  const Provider: React.FC<React.ProviderProps<Value>> = props => {\n    // Holds an actual \"props.value\"\n    const valueRef = React.useRef(props.value);\n    // Used to sync context updates and avoid stale values, can be considered as render/effect counter of Provider.\n    const versionRef = React.useRef(0);\n\n    // A stable object, is used to avoid context updates via mutation of its values.\n    const contextValue = React.useRef<ContextValue<Value>>();\n\n    if (!contextValue.current) {\n      contextValue.current = {\n        value: valueRef,\n        version: versionRef,\n        listeners: [],\n      };\n    }\n\n    useIsomorphicLayoutEffect(() => {\n      valueRef.current = props.value;\n      versionRef.current += 1;\n\n      runWithNormalPriority(() => {\n        (contextValue.current as ContextValue<Value>).listeners.forEach(listener => {\n          listener([versionRef.current, props.value]);\n        });\n      });\n    }, [props.value]);\n\n    return React.createElement(Original, { value: contextValue.current }, props.children);\n  };\n\n  /* istanbul ignore else */\n  if (process.env.NODE_ENV !== 'production') {\n    Provider.displayName = 'ContextSelector.Provider';\n  }\n\n  return Provider;\n};\n\nexport const createContext = <Value>(defaultValue: Value): Context<Value> => {\n  const context = React.createContext<ContextValue<Value>>({\n    value: { current: defaultValue },\n    version: { current: -1 },\n    listeners: [],\n  });\n\n  context.Provider = createProvider<Value>(context.Provider) as any;\n\n  // We don't support Consumer API\n  delete ((context as unknown) as Context<Value>).Consumer;\n\n  return (context as unknown) as Context<Value>;\n};\n"],"file":"createContext.js"}